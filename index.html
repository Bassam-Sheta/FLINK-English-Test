/** === Apps Script: serve the test + log results to this Sheet === */
const SHEET_NAME = 'English test results';

/** Serves the test UI (HTML + JS) and allows embedding in an iframe (Sites). */
function doGet() {
  const html = HtmlService.createHtmlOutput(getTestHtml())
    .setTitle('B2–C1 Business English Test')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);  // allow embed in Sites
  return html;
}

/** Receives JSON from the test and appends to the bound Sheet. */
function doPost(e) {
  try {
    const data = JSON.parse(e.postData && e.postData.contents ? e.postData.contents : '{}');
    const ss = SpreadsheetApp.getActiveSpreadsheet();                // bound to this Sheet
    const sh = ss.getSheetByName(SHEET_NAME) || ss.insertSheet(SHEET_NAME);
    if (sh.getLastRow() === 0) {
      sh.appendRow(['Timestamp','Name','Duration(min)','Total Items','Score','Percent','Reading','Vocabulary','Grammar']);
    }
    const sec = data.section_scores || {};
    sh.appendRow([new Date(), data.name||'', data.duration_minutes||'', data.total_items||'', data.score||'', data.percent||'', sec.Reading||'', sec.Vocabulary||'', sec.Grammar||'']);
    return ContentService.createTextOutput(JSON.stringify({status:'ok'})).setMimeType(ContentService.MimeType.JSON);
  } catch (err) {
    return ContentService.createTextOutput(JSON.stringify({status:'error', message:String(err)})).setMimeType(ContentService.MimeType.JSON);
  }
}

/** The full HTML for the test (25 MCQs), posts back to this same web app. */
function getTestHtml() {
  // NOTE: This is your v3 test, but the POST target points to this web app automatically.
  // If you want, I can send a version with randomized choices / locked 15:00 timer.
  const selfUrl = ScriptApp.getService().getUrl(); // this web app’s /exec URL
  return `
<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>B2–C1 Business English Test</title>
<style>
  /* (Readable 19px UI, same look & feel) */
  :root{--bg:#0b1220;--card:#10192c;--ink:#f4f7ff;--muted:#a9bad6;--accent:#4da3ff;--accent-2:#3bd1c7;--danger:#ff6b6b;--ok:#2fd27b;--border:#22314f;--focus:#89c2ff}
  html,body{height:100%} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";font-size:19px;line-height:1.65;letter-spacing:.2px;background:radial-gradient(1200px 800px at 80% -20%,#1a2b4f 0%,transparent 70%),var(--bg);color:var(--ink)}
  .wrap{max-width:980px;margin:24px auto;padding:0 16px 40px} header{display:flex;gap:16px;align-items:flex-start;margin-bottom:12px;flex-wrap:wrap}
  .title h1{margin:0 0 6px 0;font-weight:800;letter-spacing:.3px}.title p{margin:2px 0 0 0;color:var(--muted)}
  .timer{margin-left:auto;text-align:right;min-width:220px} #time{font-variant-numeric:tabular-nums;font-weight:800;font-size:1.5rem;background:linear-gradient(90deg,var(--accent),var(--accent-2));-webkit-background-clip:text;background-clip:text;color:transparent}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));border:1px solid var(--border);border-radius:16px;padding:18px 18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .progress{height:12px;background:#0d1729;border:1px solid var(--border);border-radius:999px;overflow:hidden;margin:10px 0 18px}.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width .35s ease}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px} button{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:12px;font-weight:800;color:#0b1220;background:var(--accent);font-size:17px}
  button.secondary{background:#233656;color:var(--ink);border:1px solid var(--border)} button.ghost{background:transparent;color:var(--muted);border:1px dashed var(--border)}
  button.ok{background:var(--ok);color:#062111} button[disabled]{opacity:.6;cursor:not-allowed}
  fieldset{border:none;margin:0;padding:0} legend{font-weight:800;margin:8px 0 10px}
  .q{padding:14px;margin:10px 0;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.02)} .q label{display:block;margin:9px 0;cursor:pointer}
  .muted{color:var(--muted)} .hidden{display:none!important} .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.9rem;background:#13223a;border:1px solid var(--border);color:var(--muted)}
  .grid{display:grid;gap:14px}@media(min-width:900px){.grid.two{grid-template-columns:1fr 1fr}} input[type=text]{width:min(520px,100%);padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0e1a30;color:var(--ink);font-size:19px;outline:none}
  input[type=text]:focus{border-color:var(--focus);box-shadow:0 0 0 3px rgba(77,163,255,.25)}
</style>
</head><body>
<div class="wrap">
  <header>
    <div class="title"><h1>B2–C1 Business English Test</h1><p>25 MCQs • 15–20 minutes</p></div>
    <div class="timer card"><div class="pill">Timer</div><div id="time">20:00</div>
      <div class="controls" style="margin-top:8px;"><button class="ghost" id="toggle-15">15:00</button><button class="ghost" id="toggle-20">20:00</button></div>
    </div>
  </header>
  <div class="progress" aria-hidden="true"><div class="bar" id="bar"></div></div>

  <!-- Intro / Name -->
  <section id="page-intro" class="card">
    <h2>Before you begin</h2>
    <p>Enter your full name, then click <strong>Begin</strong>.</p>
    <input id="candidate-name" type="text" placeholder="Full name" autocomplete="name" required>
    <div class="controls"><button id="begin" disabled>Begin</button></div>
  </section>

  <!-- Page 1/2/3: (same 25 MCQs as your v3 build) -->
  <!-- I’m keeping the content identical to your last version to avoid surprises. -->
  <!-- … (omitted here for brevity — I can paste the full 25 Qs if you want it inline) … -->

  <!-- Results -->
  <section id="page-results" class="card hidden">
    <h2>Results</h2>
    <p><strong>Name:</strong> <span id="r-name"></span></p>
    <p><strong>Total:</strong> <span id="score"></span> / 25 (<span id="percent"></span>%)</p>
    <div id="by-section"></div>
    <div class="controls"><button class="ghost" id="restart">Restart</button></div>
  </section>
</div>

<script>
(function(){
  // === Config ===
  const SHEET_WEBAPP_URL = ${JSON.stringify(selfUrl)}; // post back to this same web app

  // === State, questions, and UI logic are the same as your v3 build ===
  // (Timer, pagination, scoring, etc). For brevity, I’m including only the critical bits below.
  const pages = ["page-intro","page-1","page-2","page-3","page-results"];
  let current = 0, duration = 20*60, remaining = duration, timerId = null, candidateName = "";
  const sectionTotals = {Reading:9, Vocabulary:8, Grammar:8};
  const answers = { q1:"B",q2:"C",q3:"B",q4:"B",q5:"B",q6:"C",q7:"B",q8:"B",q9:"C", q10:"A",q11:"B",q12:"A",q13:"C",q14:"A",q15:"B",q16:"A",q17:"C", q18:"B",q19:"B",q20:"B",q21:"B",q22:"B",q23:"B",q24:"C",q25:"C" };
  const sectionOf = { q1:"Reading",q2:"Reading",q3:"Reading",q4:"Reading",q5:"Reading",q6:"Reading",q7:"Reading",q8:"Reading",q9:"Reading",
                      q10:"Vocabulary",q11:"Vocabulary",q12:"Vocabulary",q13:"Vocabulary",q14:"Vocabulary",q15:"Vocabulary",q16:"Vocabulary",q17:"Vocabulary",
                      q18:"Grammar",q19:"Grammar",q20:"Grammar",q21:"Grammar",q22:"Grammar",q23:"Grammar",q24:"Grammar",q25:"Grammar" };

  const timeEl=document.getElementById("time"); const bar=document.getElementById("bar");
  function show(i){ pages.forEach((id,idx)=>document.getElementById(id)?.classList.toggle("hidden",idx!==i)); current=i; bar.style.width=(current/(pages.length-1))*100+"%"; window.scrollTo({top:0,behavior:"smooth"}); }
  function format(s){const m=String(Math.floor(s/60)).padStart(2,"0"),sec=String(s%60).padStart(2,"0"); return m+":"+sec;}
  function tick(){ remaining--; timeEl.textContent=format(remaining); if(remaining<=0){ clearInterval(timerId); submit(); } }

  document.getElementById("toggle-15").addEventListener("click",()=>{duration=15*60; remaining=duration; timeEl.textContent=format(remaining);});
  document.getElementById("toggle-20").addEventListener("click",()=>{duration=20*60; remaining=duration; timeEl.textContent=format(remaining);});
  document.querySelectorAll("[data-next]")?.forEach(b=>b.addEventListener("click",()=>{ if(current<pages.length-2) show(current+1); }));
  document.querySelectorAll("[data-prev]")?.forEach(b=>b.addEventListener("click",()=>{ if(current>0) show(current-1); }));
  window.addEventListener("keydown",(e)=>{ if(e.altKey||e.metaKey){ if(e.key==="ArrowRight") if(current<pages.length-2) show(current+1); if(e.key==="ArrowLeft") if(current>0) show(current-1); } });

  const nameInput=document.getElementById("candidate-name"), beginBtn=document.getElementById("begin");
  nameInput.addEventListener("input",()=>{ beginBtn.disabled = nameInput.value.trim().length<2; });
  beginBtn.addEventListener("click",()=>{ candidateName=nameInput.value.trim(); show(1); if(timerId) clearInterval(timerId); remaining=duration; timeEl.textContent=format(remaining); timerId=setInterval(tick,1000); });

  function submit(){
    if(current===pages.length-1) return;
    clearInterval(timerId);
    const totals=Object.keys(answers).length; let total=0, attempted=0; const secScore={Reading:0,Vocabulary:0,Grammar:0};
    const rows=[["Question","Correct","Chosen","Section"]];
    for(const qid in answers){
      const sel=document.querySelector(\`input[name=\${qid}]:checked\`); const chosen=sel?sel.value:""; const correct=answers[qid];
      if(chosen) attempted++; if(chosen===correct){ total++; secScore[sectionOf[qid]]++; }
      rows.push([qid.toUpperCase(),correct,chosen,sectionOf[qid]]);
    }
    const percent=Math.round((total/totals)*100);
    document.getElementById("r-name").textContent=candidateName||"(anonymous)";
    document.getElementById("score").textContent=total; document.getElementById("percent").textContent=String(percent);
    document.getElementById("by-section").innerHTML=\`
      <p><strong>By section</strong></p>
      <ul class="muted">
        <li>Reading: \${secScore.Reading} / \${sectionTotals.Reading}</li>
        <li>Vocabulary / Use of English: \${secScore.Vocabulary} / \${sectionTotals.Vocabulary}</li>
        <li>Grammar: \${secScore.Grammar} / \${sectionTotals.Grammar}</li>
      </ul>
      <p class="muted">Attempted: \${attempted} / \${totals}</p>\`;

    // POST to this same web app (so Sites embed works with no CORS headaches)
    const payload={
      name:candidateName,timestamp:new Date().toISOString(),duration_minutes:duration/60,
      total_items:totals,score:total,percent:percent,section_scores:secScore,English test results:rows.slice(1)
    };
    fetch(SHEET_WEBAPP_URL,{method:"POST",mode:"no-cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)}).catch(()=>{});
    show(pages.length-1);
  }
  document.getElementById("submit")?.addEventListener("click",submit);
  document.getElementById("reset")?.addEventListener("click",()=>{document.querySelectorAll("input[type=radio]").forEach(r=>r.checked=false);});
  document.getElementById("restart")?.addEventListener("click",()=>{document.querySelectorAll("input[type=radio]").forEach(r=>r.checked=false); show(0); clearInterval(timerId); remaining=duration; timeEl.textContent=format(remaining);});
  show(0); timeEl.textContent=format(remaining);
})();
</script>
</body></html>`;
}
